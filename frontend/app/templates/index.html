<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Folo-Lite</title>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- Pico CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    
    <style>
        :root { --pico-font-size: 100%; --pico-background-color: #f8f9fa; }
        .layout { display: grid; grid-template-columns: 280px 1fr; gap: 2rem; max-width: 1200px; margin: 0 auto; padding: 1rem; }
        @media (max-width: 768px) { 
            .layout { grid-template-columns: 1fr; } 
            .sidebar { margin-bottom: 2rem; }
        }
        
        .sidebar { background: #fff; padding: 1.5rem; border-radius: 8px; height: fit-content; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .feed-list { list-style: none; padding: 0; margin: 0; }
        .feed-list li { margin-bottom: 0.2rem; }
        
        /* Sidebar Links */
        .feed-list a { 
            color: #555; 
            text-decoration: none; 
            font-size: 0.9rem; 
            display: block; 
            padding: 0.4rem 0.6rem;
            border-radius: 4px;
        }
        .feed-list a:hover { background-color: #f0f0f0; color: #000; }
        .feed-list a.active { background-color: #e3f2fd; color: #0d47a1; font-weight: bold; }

        /* Article Card */
        .article-card { 
            background: white; 
            padding: 1.5rem; 
            margin-bottom: 1rem; 
            border-radius: 8px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }
        .article-card:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        /* READ State: Dimmed */
        .article-card.read { 
            opacity: 0.6; 
            background-color: #fafafa;
            border-left: 4px solid #e0e0e0;
        }
        .article-card.read:hover { opacity: 0.9; }

        .meta { font-size: 0.8rem; color: #6c757d; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
        .feed-badge { background-color: #e9ecef; color: #495057; padding: 0.2rem 0.6rem; border-radius: 4px; font-weight: bold; font-size: 0.7rem; text-transform: uppercase; }
    </style>
</head>
<body>

    <nav class="container-fluid" style="background: white; border-bottom: 1px solid #eee; padding: 0.75rem 2rem;">
        <ul>
            <li><strong>Folo-Lite</strong></li>
        </ul>
        <ul>
            <li><small>{{ user.email }}</small></li>
            <li>
                <form action="/auth/logout" method="post" style="margin:0;">
                    <button class="outline secondary" style="padding: 0.4rem 1rem; font-size: 0.8rem; border: none;">Logout</button>
                </form>
            </li>
        </ul>
    </nav>

    <div class="layout">
        
        <aside class="sidebar">
            <!-- Add Feed -->
            <form hx-post="/feeds" hx-indicator="#loading" hx-swap="none">
                <label for="url"><strong>Add New Feed</strong></label>
                <fieldset role="group">
                    <input type="url" name="url" id="url" placeholder="https://site.com/rss" required>
                    <button type="submit" class="contrast">+</button>
                </fieldset>
                <small id="loading" class="htmx-indicator">Fetching & parsing...</small>
            </form>

            <hr>

            <!-- Feed List -->
            <details open>
                <summary><strong>My Subscriptions</strong></summary>
                <ul class="feed-list" style="margin-top: 1rem;">
                    <li>
                        <a href="/" class="{{ 'active' if not current_feed_id else '' }}">
                            All Feeds
                        </a>
                    </li>
                    {% for feed in feeds %}
                        <li>
                            <!-- We match IDs as strings just to be safe in Jinja -->
                            <a href="/?feed_id={{ feed.id }}" 
                               class="{{ 'active' if current_feed_id == feed.id else '' }}">
                                {{ feed.title }}
                            </a>
                        </li>
                    {% else %}
                        <li><small style="color: #999;">No feeds yet.</small></li>
                    {% endfor %}
                </ul>
            </details>
        </aside>

        <section id="timeline">
            {% if not articles %}
                <div style="text-align: center; margin-top: 4rem; color: #777;">
                    <h3>No articles here.</h3>
                    <p>Select "All Feeds" or add a new source.</p>
                </div>
            {% endif %}

            {% for article in articles %}
            <!-- We add the 'read' class conditionally based on DB state -->
            <div class="article-card {{ 'read' if article.is_read else '' }}" id="article-{{ article.id }}">
                <div class="meta">
                    <span class="feed-badge">{{ article.feeds.title }}</span>
                    <span>{{ article.published_at[:10] }}</span>
                </div>
                
                <h3 style="margin-bottom: 0.5rem;">
                    <!-- Clicking title opens new tab AND marks read via hx-post -->
                    <a href="{{ article.url }}" 
                       target="_blank" 
                       rel="noopener" 
                       style="text-decoration: none; color: #111;"
                       hx-post="/articles/{{ article.id }}/read"
                       hx-swap="none"
                       onclick="document.getElementById('article-{{ article.id }}').classList.add('read')">
                        {{ article.title }}
                    </a>
                </h3>

                <!-- Expanding preview ALSO marks as read -->
                <details 
                    {% if not article.is_read %}
                        hx-post="/articles/{{ article.id }}/read"
                        hx-trigger="click once"
                        hx-swap="none"
                        onclick="document.getElementById('article-{{ article.id }}').classList.add('read')"
                    {% endif %}
                >
                    <summary role="button" class="outline secondary" style="font-size: 0.75rem; padding: 0.2rem 0.8rem; border-radius: 20px; width: fit-content; margin-top: 0.5rem;">
                        Show Preview
                    </summary>
                    <div style="margin-top: 1rem; font-size: 0.95rem; line-height: 1.6; color: #333; overflow-wrap: break-word;">
                        {{ article.content | safe }}
                    </div>
                </details>
            </div>
            {% endfor %}
        </section>
    </div>

</body>
</html>
